<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
  </head>
  <body>
    <button id="button-resume">Resume Audio Context</button>
    <button id="button-bend-0">Bend 0%</button>
    <button id="button-bend-1">Bend 10%</button>
    <button id="button-bend-5">Bend 50%</button>
    <button id="button-bend-20">Bend 100%</button>
    <input id="open" type="file" accept=".mid,.midi" />
    <div id="keys"></div>
    <script type="module">
      const context = new AudioContext()
      let synth

      const setup = async () => {
        await context.audioWorklet.addModule("js/synth-processor.js")
        synth = new AudioWorkletNode(context, "synth-processor")
        synth.connect(context.destination)
      }

      const getSampleUrls = () => {
        const baseUrl = "/midi-js-soundfonts/MusyngKite/clarinet-mp3/"
        const ext = ".mp3"
        const keys = [
          "C",
          "Db",
          "D",
          "Eb",
          "E",
          "F",
          "Gb",
          "G",
          "Ab",
          "A",
          "Bb",
          "B",
        ]
        return [1, 2, 3].flatMap((oct) =>
          keys.map((key) => `${baseUrl}${key}${oct}${ext}`)
        )
      }

      const createKeyButton = (pitch) => {
        const elm = document.createElement("button")
        elm.textContent = pitch
        elm.onpointerdown = () => {
          noteOn(pitch)
        }
        elm.onpointerup = () => {
          noteOff(pitch)
        }

        const keyContainer = document.getElementById("keys")
        keyContainer.appendChild(elm)
      }

      const loadSample = async (url, pitch) => {
        const req = await fetch(url, { type: "GET" })
        const audioData = await req.arrayBuffer()
        console.log(`loaded sample for pitch ${pitch} from ${url}`)
        context.decodeAudioData(audioData, (buffer) => {
          const data = buffer.getChannelData(0)
          synth.port.postMessage({ type: "loadSample", pitch, data })
        })
      }

      const delayTime = 0 // context.sampleRate * 0.5

      const noteOn = (pitch, velocity = 100, channel = 0) => {
        context.resume()
        synth.port.postMessage({
          type: "noteOn",
          pitch,
          velocity,
          delayTime,
          channel,
        })
      }

      const noteOff = (pitch, channel = 0) => {
        synth.port.postMessage({
          type: "noteOff",
          pitch,
          delayTime,
          channel,
        })
      }

      const pitchBend = (value, channel = 0) => {
        synth.port.postMessage({
          type: "pitchBend",
          value,
          delayTime,
          channel,
        })
      }

      const volume = (value, channel = 0) => {
        synth.port.postMessage({
          type: "volume",
          value,
          delayTime,
          channel,
        })
      }

      await setup()

      let pitch = 0
      for await (let url of getSampleUrls()) {
        await loadSample(url, pitch++)
        createKeyButton(pitch)
      }

      document.getElementById("button-bend-0").onclick = () => {
        pitchBend(1)
      }

      document.getElementById("button-bend-1").onclick = () => {
        pitchBend(1.1)
      }

      document.getElementById("button-bend-5").onclick = () => {
        pitchBend(1.5)
      }

      document.getElementById("button-bend-20").onclick = () => {
        pitchBend(2)
      }

      document.getElementById("button-resume").onclick = () => {
        context.resume()
      }

      document.getElementById("open").onchange = (e) => {
        const reader = new FileReader()
        reader.onload = () => {
          console.log(reader.result)
        }
        reader.readAsArrayBuffer(e.currentTarget.files[0])
      }

      try {
        const midiAccess = await navigator.requestMIDIAccess({ sysex: false })

        midiAccess.inputs.forEach((entry) => {
          entry.onmidimessage = (event) => {
            switch (event.data[0] & 0xf0) {
              case 0x90:
                noteOn(event.data[1], event.data[2])
                break
              case 0x80:
                noteOff(event.data[1])
                break
              case 0xb0:
                switch (event.data[1]) {
                  case 0x07:
                    volume(event.data[2])
                    break
                }
            }

            const bytesStr = Array.from(event.data)
              .map((d) => "0x" + d.toString(16))
              .join(" ")
            console.log("MIDI Event: ", bytesStr)
          }
        })
      } catch (e) {
        console.error(e)
      }
    </script>
  </body>
</html>
