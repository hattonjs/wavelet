<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
  </head>
  <body>
    <button id="button">Start</button>
    <button id="button-note-on">Note on</button>
    <button id="button-note-off">Note off</button>
    <script type="module">
      const context = new AudioContext()
      let bypasser

      const setup = async () => {
        await context.audioWorklet.addModule("bypass-processor.js")
        const oscillator = new OscillatorNode(context)
        bypasser = new AudioWorkletNode(context, "bypass-processor")
        oscillator.connect(bypasser).connect(context.destination)
        oscillator.start()
      }

      const loadSample = async () => {
        const req = await fetch("piano.mp3", { type: "GET" })
        const audioData = await req.arrayBuffer()
        context.decodeAudioData(audioData, (buffer) => {
          bypasser.port.postMessage(buffer.getChannelData(0))
        })
      }

      await setup()
      await loadSample()

      document.getElementById("button").onclick = () => {
        context.resume()
      }

      document.getElementById("button-note-on").onclick = () => {
        bypasser.port.postMessage("noteOn")
      }

      document.getElementById("button-note-off").onclick = () => {
        bypasser.port.postMessage("noteOff")
      }
    </script>
  </body>
</html>
